# 应答机系统2.4G私有协议

## 1. 系统架构概述

### 1.1 系统组成
- **网关（Gateway）**：1台，负责协调和管理所有应答机
- **应答机（Node）**：最多60台，学生使用的应答设备
- **通信频段**：2.4GHz ISM频段

### 1.2 频道规划
- **入网频道**：0和6（0-5 信道对应频率：2400M + CHAN * 2M

  ​				6-11 信道对应频率：2508M + (CHAN-6）* 2M）

- **工作频道**：1~5和7~11（共10个信道）

- **空中速率**：250kbps

- **传输模式**：透明传输

## 2. 协议栈结构

### 2.1 协议分层

|  应用层 (Application)  |
| :--------------------: |
|    网络层 (Network)    |
| 数据链路层 (Data Link) |
|   物理层 (Physical)    |

## 3. 数据帧格式定义

### 3.1 通用帧格式

| 起始符 | 长度  | 帧类型 | 数据载荷 | CRC16 | 结束符 |
| :----: | :---: | :----: | :------: | :---: | :----: |
| 2字节  | 1字节 | 1字节  |  N字节   | 2字节 | 2字节  |
| 0xA5A5 |       |        |          |       | 0xFAFA |

### 3.2 字段说明
- **起始符**：0xA5A5，帧起始标识
- **长度**：数据载荷长度（不包含CRC和结束符）
- **帧类型**：定义帧的功能类型
- **数据载荷**：实际传输的数据
- **CRC16**：循环冗余校验
- **结束符**：0xFAFA，帧结束标识

## 4. 帧类型定义

### 4.1 入网阶段帧类型
| 帧类型 | 值   | 方向     | 描述                |
|--------|------|----------|---------------------|
| JOIN_BEACON | 0x01 | GW→Node | 网关入网广播帧     |
| JOIN_REQ    | 0x02 | Node→GW | 节点入网请求帧     |
| JOIN_RESP   | 0x03 | GW→Node | 网关入网响应帧     |
| JOIN_ACK    | 0x04 | Node→GW | 节点入网确认帧     |

### 4.2 正常使用阶段帧类型
| 帧类型 | 值   | 方向     | 描述                |
|--------|------|----------|---------------------|
| ANSWER_REQ  | 0x11 | Node→GW | 应答数据上传帧     |
| ANSWER_ACK  | 0x12 | GW→Node | 应答确认帧         |
| RESET_CMD   | 0x14 | GW→Node | 重置命令帧         |

## 5. 入网阶段协议流程

### 5.1 入网状态机
```
节点状态：IDLE → JOINING → JOINED → WORKING
网关状态：BEACON → PROCESSING → WORKING
```

### 5.2 入网流程
1. **网关广播阶段**
   - 网关在入网频道（0、6）周期性广播JOIN_BEACON帧
   - 广播间隔：100ms（每个频道广播100ms）
   - 广播时长：可配置（默认30秒）

2. **节点入网请求**
   - 节点按键进入入网模式
   - 切换到入网频道监听JOIN_BEACON（每隔250mm切换一次信道）
   - 收到信号强度>-70dBm的JOIN_BEACON后立即发送JOIN_REQ

3. **网关响应处理**
   - 网关收到JOIN_REQ后检查信号强度
   - 信号强度>-70dBm才处理入网请求
   - 分配节点ID并发送JOIN_RESP

4. **入网确认**
   - 节点收到JOIN_RESP后发送JOIN_ACK
   - 网关收到JOIN_ACK后入网完成

### 5.3 入网帧格式

#### 5.3.1 JOIN_BEACON帧

| 网关ID | 工作频道 | 保留  |
| :----: | :------: | :---: |
| 4字节  |  1字节   | 3字节 |

#### 5.3.2 JOIN_REQ帧

| 网关ID | 节点ID | 信号强度 | 保留  |
| :----: | :----: | :------: | :---: |
| 4字节  | 4字节  |  1字节   | 3字节 |

#### 5.3.3 JOIN_RESP帧

| 网关ID | 节点ID | 工作频道 | 时隙  | 保留  |
| :----: | :----: | :------: | :---: | :---: |
| 4字节  | 4字节  |  1字节   | 1字节 | 2字节 |

#### 5.3.4 JOIN_ACK帧

| 网关ID | 节点ID | 状态  | 保留  |
| :----: | :----: | :---: | :---: |
| 4字节  | 4字节  | 1字节 | 3字节 |

## 6. 正常使用阶段协议流程

### 6.1 纯事件驱动模式
- **节点默认状态**：深度休眠，仅保持按键检测
- **通信触发**：仅在按键时唤醒并发起通信
- **网关管理**：被动接收节点请求，无主动轮询

### 6.2 应答上传流程
1. **学生按键**
   - 节点从深度休眠唤醒
   - 检测按键类型（A/B/C/D/E/F选项）
   - 切换到工作频道准备通信

2. **随机退避**
   - 生成随机退避时间：T = random(0, 2^n) × 时隙长度
   - 初始退避窗口：n=3（0-7个时隙）
   - 最大退避窗口：n=6（0-63个时隙）
   - 时隙长度：10ms

3. **数据上传**
   - 发送ANSWER_REQ帧
   - 等待ANSWER_ACK确认
   - 超时重传最大3次

4. **确认接收**
   - 收到ANSWER_ACK后立即进入深度休眠
   - 未收到确认则增加退避窗口重传
   - 超过最大重传次数后放弃并休眠

### 6.2 应答帧格式

#### 6.2.1 ANSWER_REQ帧

| 网关ID | 节点ID | 序列号 | 选项  | 电池电量 |
| :----: | :----: | :----: | :---: | :------: |
| 4字节  | 4字节  | 2字节  | 1字节 |  1字节   |

#### 6.2.2 ANSWER_ACK帧

| 网关ID | 节点ID | 状态  | 保留  |
| :----: | :----: | :---: | :---: |
| 4字节  | 4字节  | 1字节 | 3字节 |

## 7. 冲突避免机制

### 7.1 CSMA/CA机制
1. **载波侦听**
   
   - 发送前先侦听信道20ms
   - 检测到信道忙则等待信道空闲
   
2. **随机退避算法**
   ```
   退避时间 = random(0, 2^min(重传次数, 6)) × 10ms
   ```

3. **重传机制**
   - 最大重传次数：3次
   - 重传间隔：指数退避
   - 超过最大重传次数则放弃

### 7.2 时隙分配
- 将时间分为10ms时隙
- 每个节点分配基础时隙号
- 冲突时使用随机时隙

## 8. 电源管理

### 8.1 节点休眠机制
1. **休眠触发条件**
   - 收到ANSWER_ACK确认
   - 无按键操作超过30秒
   - 电池电量低于10%
2. **休眠状态**
   - 关闭射频模块
   - 保持按键检测
   - 完全静态，无主动通信
3. **唤醒条件**
   - 按键按下

## 9. 错误处理

### 9.1 错误类型
- **CRC错误**：丢弃帧，等待重传
- **超时错误**：重传，最大3次
- **序列号错误**：发送NAK帧
- **节点ID错误**：忽略处理

### 9.2 异常恢复
- **网关重启**：节点检测到通信失败时，自动重新入网
- **频道干扰**：网关自动切换备用频道并广播通知
- **通信中断**：节点按键时发现通信失败，提示重新入网
- **长时间无通信**：网关可发送广播重置命令，节点收到后重新入网

## 10. 性能参数

### 10.1 系统指标
- **支持节点数**：最大60个
- **通信距离**：室内30米
- **数据速率**：250kbps
- **延时**：<100ms（正常情况）
- **电池寿命**：>12个月（纯事件驱动，无心跳）

### 10.2 可靠性指标
- **误码率**：<10^-6
- **丢包率**：<1%
- **重传成功率**：>99%
